--- 
- name: Patch the chaoslib image
  template:
    src:  /chaoslib/pumba/pumba.j2
    dest: /chaoslib/pumba/pumba_kube.yml
  vars:
    pumba_image: "{{ lib_image }}"

- name: Setup pumba chaos infrastructure
  shell: >
    kubectl apply -f /chaoslib/pumba/pumba_kube.yml
    -n {{ a_ns }}
  args:
    executable: /bin/bash
  register: result

- name: Confirm that the pumba ds is running on all nodes
  shell: >
    kubectl get pod -l app=pumba 
    --no-headers -o custom-columns=:status.phase
    -n {{ a_ns }} | sort | uniq
  args: 
    executable: /bin/bash
  register: result
  until: "result.stdout == 'Running'"
  delay: 20
  retries: 15

- name: Derive PV from application PVC 
  shell: >
    kubectl get pvc {{ a_pvc }}
    -o custom-columns=:spec.volumeName -n {{ a_ns }}
    --no-headers
  args:
    executable: /bin/bash
  register: pv

- name: Pick a cStor target pod belonging to the PV
  shell: >
    kubectl get pods -l {{ cstor_target_pod_label }}
    -n {{ openebs_ns }} --no-headers | grep {{ pv.stdout }}
    | shuf -n1 | awk '{print $1}'
  args:
    executable: /bin/bash
  register: cstor_target_pod

- name: Record the cstor target container name
  set_fact:
    # Depends on the naming convention in maya-apiserver (<pv-id>-rep)
    cstor_target_name: "{{ pv.stdout }}-{{ cstor_target_pod_suffix }}"

- name: Get the node on which the cstor target is scheduled
  shell: >
    kubectl get pod {{ cstor_target_pod.stdout }} -n {{ openebs_ns }}
    --no-headers -o custom-columns=:spec.nodeName
  args:
    executable: /bin/bash
  register: node  

- name: Identify the pumba pod that co-exists with cstor target
  shell: >
    kubectl get pods -l app=pumba -n {{ a_ns }} 
    -o jsonpath='{.items[?(@.spec.nodeName==''"{{ node.stdout }}"'')].metadata.name}'
  args:
    executable: /bin/bash
  register: pumba_pod

# including pumba lib  -> induce_latency
- name: Inject egress delay of {{ network_delay }}ms on cstor target for {{ chaos_duration }}ms
  include_tasks: /chaoslib/pumba/network_chaos/induce_latency.yml
  vars:
    n_interface: "eth0"
    n_latency: "{{ n_delay }}"
    c_container: "cstor-istgt"
    app_pod: "{{ cstor_target_name }}"

- name: Wait for 10s post fault injection 
  wait_for:
    timeout: 10

- name: Delete the pumba daemonset 
  shell: kubectl delete -f /chaoslib/pumba/pumba_kube.yml -n {{ a_ns }} 
  args:
    executable: /bin/bash
  register: result

- name: Confirm that the pumba ds is deleted successfully
  shell: >
    kubectl get pods -l app=pumba --no-headers -n {{ a_ns }}
  args:
    executable: /bin/bash
  register: result
  until: "'Running' not in result.stdout"
  delay: 20
  retries: 15
